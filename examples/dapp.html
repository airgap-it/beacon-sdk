<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Beacon Example DApp</title>

    <script src="https://cdn.tailwindcss.com"></script>

    <script>
      // This will enable the debug mode of beacon
      // This should only be used during development
      window.beaconSdkDebugEnabled = true
    </script>

    <script src="./walletbeacon.min.js"></script>
    <script src="./beacon-utils.js"></script>
  </head>

  <body class="bg-gray-900 min-h-screen">
    <div class="container mx-auto px-4 py-8 max-w-6xl">
      <!-- Header -->
      <header class="mb-8">
        <h1 class="text-4xl font-bold text-white mb-2">Beacon Example DApp</h1>
        <p class="text-gray-400">Test Beacon SDK integration and wallet interactions</p>
      </header>

      <!-- Configuration and Active Account Section -->
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
        <!-- Configuration Section -->
        <section class="bg-gray-800 rounded-lg shadow-lg p-6">
          <h2 class="text-xl font-semibold text-white mb-4">Configuration</h2>

          <div class="space-y-4">
            <!-- Blockchain Selection -->
            <div>
              <label class="block text-sm font-medium text-gray-300 mb-2">Blockchain</label>
              <select id="blockchainSelect" class="w-full px-3 py-2 bg-gray-700 border border-gray-600 text-white rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                <option value="tezos">Tezos</option>
                <option value="tezos-tezlink">Tezos-Tezlink</option>
              </select>
            </div>

            <!-- Network Selection -->
            <div>
              <label class="block text-sm font-medium text-gray-300 mb-2">Network</label>
              <select id="networkSelect" class="w-full px-3 py-2 bg-gray-700 border border-gray-600 text-white rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"></select>
            </div>

            <!-- Custom RPC URL (hidden by default, shown for Tezlink or custom network) -->
            <div id="customRpcContainer" style="display: none;">
              <label class="block text-sm font-medium text-gray-300 mb-2">RPC URL</label>
              <input type="text" id="customRpcUrl" class="w-full px-3 py-2 bg-gray-700 border border-gray-600 text-white rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Enter RPC URL" />
            </div>

            <!-- Protocol Version -->
            <div>
              <label class="block text-sm font-medium text-gray-300 mb-2">Preferred Protocol (max)</label>
              <select id="protocolSelect" class="w-full px-3 py-2 bg-gray-700 border border-gray-600 text-white rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                <option value="1">1 - Legacy (base58)</option>
                <option value="2">2 - Compressed (gzip)</option>
              </select>
            </div>

            <!-- Negotiated Protocol -->
            <div>
              <label class="block text-sm font-medium text-gray-300 mb-2">Negotiated Protocol</label>
              <div>
                <span id="negotiatedProtocol" class="inline-block px-2 py-1 bg-gray-700 text-gray-300 rounded text-xs">—</span>
              </div>
            </div>

            <!-- Connection Buttons -->
            <div class="space-y-2 pt-2">
              <button id="requestPermission" class="w-full px-6 py-3 bg-blue-600 text-white rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 transition">
                Request Permission
              </button>
              <button id="requestPermissionAndSign" class="w-full px-6 py-3 bg-blue-600 text-white rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 transition">
                Request Permission & Sign
              </button>
            </div>
          </div>
        </section>

        <!-- Active Account Section -->
        <section class="bg-gray-800 border-l-4 border-l-blue-600 border-t border-r border-b border-gray-700 rounded-lg shadow-lg p-6">
          <div class="flex items-center justify-between mb-4">
            <h2 class="text-xl font-semibold text-white">Active Account</h2>
            <button id="disconnect" disabled class="px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700 transition text-sm disabled:opacity-50 disabled:cursor-not-allowed">
              Disconnect
            </button>
          </div>

          <div class="space-y-3">
            <!-- Address -->
            <div>
              <div class="text-xs text-gray-400 mb-1">Address</div>
              <div class="flex items-center gap-2">
                <code id="activeAccount" class="flex-1 font-mono text-white text-sm break-all">Not connected</code>
                <button id="copyAddress" class="hidden p-2 bg-gray-700 text-white rounded-md hover:bg-gray-600 transition flex-shrink-0" title="Copy address">
                  <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" />
                  </svg>
                </button>
              </div>
            </div>

            <!-- Explorer Link -->
            <div id="activeAccountExplorerWrapper" class="hidden">
              <div class="text-xs text-gray-400 mb-1">Explorer</div>
              <a id="activeAccountExplorer" href="#" target="_blank" class="text-blue-400 hover:text-blue-300 text-xs break-all underline">
                https://tzkt.io/...
              </a>
            </div>

            <!-- Details Grid -->
            <div class="grid grid-cols-2 md:grid-cols-3 gap-3">
              <div>
                <div class="text-xs text-gray-400 mb-1">Balance</div>
                <div id="activeAccountBalance" class="text-white text-sm font-medium">—</div>
              </div>
              <div>
                <div class="text-xs text-gray-400 mb-1">Network</div>
                <span id="activeAccountNetwork" class="inline-block px-2 py-1 bg-gray-700 text-gray-300 rounded text-xs"></span>
              </div>
              <div>
                <div class="text-xs text-gray-400 mb-1">Transport</div>
                <span id="activeAccountTransport" class="inline-block px-2 py-1 bg-gray-700 text-gray-300 rounded text-xs"></span>
              </div>
            </div>

            <!-- RPC -->
            <div id="activeAccountRPCWrapper" class="hidden">
              <div class="text-xs text-gray-400 mb-1">RPC Endpoint</div>
              <code id="activeAccountRPC" class="block font-mono text-white text-xs break-all">—</code>
            </div>
          </div>
        </section>
      </div>

      <!-- Send Tezos and Signing -->
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
        <!-- Send Tezos -->
        <section class="bg-gray-800 rounded-lg shadow-lg p-6">
          <h2 class="text-xl font-semibold text-white mb-4">Send Tezos</h2>
          <div class="space-y-4">
            <div>
              <label class="block text-sm font-medium text-gray-300 mb-2">Recipient Address</label>
              <div class="flex gap-2">
                <input id="sendRecipientAddress" type="text" placeholder="tz1..." class="flex-1 px-3 py-2 bg-gray-700 border border-gray-600 text-white rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm" />
                <button id="fillOwnAddress" class="p-2 bg-gray-600 text-white rounded-md hover:bg-gray-500 transition flex-shrink-0" title="Use my address">
                  <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
                  </svg>
                </button>
              </div>
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-300 mb-2">Amount (ꜩ)</label>
              <input id="sendAmount" type="number" placeholder="0.0" step="0.000001" min="0" class="w-full px-3 py-2 bg-gray-700 border border-gray-600 text-white rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm" />
            </div>
            <button id="sendTezos" class="w-full px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition text-sm">
              Send
            </button>
          </div>
        </section>

        <!-- Signing Section -->
        <section class="bg-gray-800 rounded-lg shadow-lg p-6">
          <h2 class="text-xl font-semibold text-white mb-4">Signing</h2>
          <div class="space-y-2">
            <button id="signPayloadRaw" class="w-full px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition text-sm">
              Sign Payload (Raw)
            </button>
            <button id="signPayloadOperation" class="w-full px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition text-sm">
              Sign Payload (Operation)
            </button>
            <button id="signPayloadMicheline" class="w-full px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition text-sm">
              Sign Payload (Micheline)
            </button>
            <button id="encryptPayload" class="w-full px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition text-sm">
              Encrypt Payload
            </button>
          </div>
        </section>
      </div>

      <!-- Contract Deployment and Performance Tests -->
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">

        <!-- Contract Deployment -->
        <section class="bg-gray-800 rounded-lg shadow-lg p-6">
          <h2 class="text-xl font-semibold text-white mb-4">Contract Deployment</h2>
          <div class="space-y-4">
            <!-- Deploy Button -->
            <button id="deployContract" class="w-full px-4 py-2 bg-purple-600 text-white rounded-md hover:bg-purple-700 transition text-sm">
              Deploy Hello World Contract
            </button>

            <!-- Manual Contract Address Input -->
            <div>
              <label class="block text-sm font-medium text-gray-300 mb-2">Or Set Contract Address Manually</label>
              <div class="flex gap-2">
                <input id="manualContractAddress" type="text" placeholder="KT1..." class="flex-1 px-3 py-2 bg-gray-700 border border-gray-600 text-white rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500 text-sm" />
                <button id="setManualContract" class="px-4 py-2 bg-purple-600 text-white rounded-md hover:bg-purple-700 transition text-sm">
                  Set
                </button>
              </div>
            </div>

            <!-- Contract Address Display -->
            <div id="contractAddressWrapper" class="hidden">
              <div class="text-xs text-gray-400 mb-1">Deployed Contract</div>
              <div class="flex items-center gap-2 mb-2">
                <code id="contractAddress" class="flex-1 font-mono text-white text-xs break-all bg-gray-900 p-2 rounded"></code>
                <button id="copyContractAddress" class="p-2 bg-gray-700 text-white rounded-md hover:bg-gray-600 transition flex-shrink-0" title="Copy address">
                  <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" />
                  </svg>
                </button>
              </div>
              <div class="text-xs text-gray-400 mb-1">Explorer</div>
              <a id="contractExplorer" href="#" target="_blank" class="text-blue-400 hover:text-blue-300 text-xs break-all underline">
                https://tzkt.io/...
              </a>
            </div>

            <!-- Contract Interactions -->
            <div class="border-t border-gray-700 pt-4">
              <div class="space-y-3">
                <!-- Get Value -->
                <div>
                  <label class="block text-sm font-medium text-gray-300 mb-2">Current Value</label>
                  <div class="flex gap-2">
                    <div id="contractCurrentValue" class="flex-1 px-3 py-2 bg-gray-900 text-gray-400 rounded-md text-sm">
                      No value loaded
                    </div>
                    <button id="getContractValue" disabled class="px-4 py-2 bg-purple-600 text-white rounded-md hover:bg-purple-700 transition text-sm disabled:opacity-50 disabled:cursor-not-allowed">
                      Get Value
                    </button>
                  </div>
                </div>

                <!-- Set Value -->
                <div>
                  <label class="block text-sm font-medium text-gray-300 mb-2">Set Value</label>
                  <div class="flex gap-2">
                    <input id="contractValueInput" type="text" placeholder="Enter new value..." class="flex-1 px-3 py-2 bg-gray-700 border border-gray-600 text-white rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500 text-sm" />
                    <button id="setContractValue" disabled class="px-4 py-2 bg-purple-600 text-white rounded-md hover:bg-purple-700 transition text-sm disabled:opacity-50 disabled:cursor-not-allowed">
                      Set Value
                    </button>
                  </div>
                </div>

                <!-- Clear Contract -->
                <button id="clearContract" disabled class="w-full px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700 transition text-sm disabled:opacity-50 disabled:cursor-not-allowed">
                  Clear Contract
                </button>
              </div>
            </div>
          </div>
        </section>

        <!-- Performance Tests -->
        <section class="bg-gray-800 rounded-lg shadow-lg p-6">
          <h2 class="text-xl font-semibold text-white mb-4">Performance Tests</h2>
          <div class="space-y-2">
            <button id="signPayloadLarge20" class="w-full px-4 py-2 bg-gray-600 text-white rounded-md hover:bg-gray-700 transition text-sm text-left flex items-center justify-between">
              <span>Sign Payload 20 KB</span>
            </button>
            <div id="signPayloadLarge20Result" class="text-xs text-gray-400 pl-4 min-h-[1rem]"></div>

            <button id="signPayloadLarge30" class="w-full px-4 py-2 bg-gray-600 text-white rounded-md hover:bg-gray-700 transition text-sm text-left flex items-center justify-between">
              <span>Sign Payload 30 KB</span>
            </button>
            <div id="signPayloadLarge30Result" class="text-xs text-gray-400 pl-4 min-h-[1rem]"></div>

            <button id="signPayloadLarge50" class="w-full px-4 py-2 bg-gray-600 text-white rounded-md hover:bg-gray-700 transition text-sm text-left flex items-center justify-between">
              <span>Sign Payload 50 KB</span>
            </button>
            <div id="signPayloadLarge50Result" class="text-xs text-gray-400 pl-4 min-h-[1rem]"></div>

            <button id="signPayloadLarge100" class="w-full px-4 py-2 bg-gray-600 text-white rounded-md hover:bg-gray-700 transition text-sm text-left flex items-center justify-between">
              <span>Sign Payload 100 KB</span>
            </button>
            <div id="signPayloadLarge100Result" class="text-xs text-gray-400 pl-4 min-h-[1rem]"></div>
          </div>
        </section>
      </div>

      <!-- Account Management and Utilities -->
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
        <!-- Account Management -->
        <section class="bg-gray-800 rounded-lg shadow-lg p-6">
          <h2 class="text-xl font-semibold text-white mb-4">Account Management</h2>
          <div class="space-y-2">
            <button id="getAccounts" class="w-full px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition text-sm">
              Get Accounts
            </button>
            <button id="switchAccount" class="w-full px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition text-sm">
              Switch Account
            </button>
            <button id="clearActiveAccount" class="w-full px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition text-sm">
              Clear Active Account
            </button>
            <button id="requestProofOfEventChallenge" disabled class="w-full px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition text-sm disabled:opacity-50 disabled:cursor-not-allowed">
              Request PoE Challenge
            </button>
            <button id="requestSimulatedProofOfEventChallenge" disabled class="w-full px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition text-sm disabled:opacity-50 disabled:cursor-not-allowed">
              Request Simulated PoE
            </button>
          </div>
        </section>

        <!-- Utilities -->
        <section class="bg-gray-800 rounded-lg shadow-lg p-6">
          <h2 class="text-xl font-semibold text-white mb-4">Utilities</h2>
          <div class="grid grid-cols-2 gap-3">
            <button id="showPrepareAndHide" class="px-4 py-2 bg-gray-600 text-white rounded-md hover:bg-gray-700 transition text-sm">
              Show Prepare
            </button>
            <button id="sendNotification" class="px-4 py-2 bg-gray-600 text-white rounded-md hover:bg-gray-700 transition text-sm">
              Send Notification
            </button>
            <button id="getExtensions" class="px-4 py-2 bg-gray-600 text-white rounded-md hover:bg-gray-700 transition text-sm">
              Get Extensions
            </button>
            <div class="flex items-center gap-2">
              <span class="text-xs text-gray-400">UI:</span>
              <button id="color-mode-light" class="px-3 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300 transition text-xs">
                Light
              </button>
              <button id="color-mode-dark" class="px-3 py-2 bg-gray-700 text-white rounded-md hover:bg-gray-600 transition text-xs">
                Dark
              </button>
            </div>
          </div>
          <div class="mt-3 text-xs text-gray-400">
            Color Mode: <strong id="activeColorMode" class="text-white"></strong>
          </div>
        </section>
      </div>

      <!-- Testing & Debug and Serialization Tools -->
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
        <!-- Testing & Debug -->
        <section class="bg-gray-800 rounded-lg shadow-lg p-6">
          <h2 class="text-xl font-semibold text-white mb-4">Testing & Debug</h2>
          <div class="space-y-2">
            <button id="externalInit" class="w-full px-4 py-2 bg-gray-600 text-white rounded-md hover:bg-gray-700 transition text-sm">
              External Init
            </button>
            <button id="2requests" class="w-full px-4 py-2 bg-gray-600 text-white rounded-md hover:bg-gray-700 transition text-sm">
              2 Requests at Once
            </button>
            <button id="removePeer" class="w-full px-4 py-2 bg-orange-600 text-white rounded-md hover:bg-orange-700 transition text-sm">
              Remove Peer
            </button>
            <button id="reset" class="w-full px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700 transition text-sm">
              Reset and Refresh
            </button>
            <button id="dumpState" class="w-full px-4 py-2 bg-red-700 text-white rounded-md hover:bg-red-800 font-bold transition text-sm">
              Dump DApp State
            </button>
          </div>
        </section>

        <!-- Serialization Tools -->
        <section class="bg-gray-800 rounded-lg shadow-lg p-6">
          <h2 class="text-xl font-semibold text-white mb-4">Serialization Tools</h2>
          <div class="space-y-3">
            <div>
              <label class="block text-sm font-medium text-gray-300 mb-2">Deserialize</label>
              <div class="flex gap-2">
                <textarea id="beacon-textbox" class="flex-1 px-3 py-2 bg-gray-700 border border-gray-600 text-white rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 text-xs" rows="2"></textarea>
                <button id="deserializeData" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition text-xs flex-shrink-0">
                  Run
                </button>
              </div>
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-300 mb-2">Serialize</label>
              <div class="flex gap-2">
                <textarea id="beacon-textbox-serialize" class="flex-1 px-3 py-2 bg-gray-700 border border-gray-600 text-white rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 text-xs" rows="2"></textarea>
                <button id="serializeData" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition text-xs flex-shrink-0">
                  Run
                </button>
              </div>
            </div>
          </div>
        </section>
      </div>

      <!-- Logger Output -->
      <section class="bg-gray-800 rounded-lg shadow-lg p-6">
        <h2 class="text-2xl font-semibold text-white mb-4">Logger Output</h2>
        <div id="logger-output" class="space-y-1 font-mono text-sm max-h-96 overflow-y-auto bg-gray-900 p-4 rounded-md"></div>
      </section>
    </div>

    <script>
      class MyLogger {
        constructor() {}

        debug(name, method, ...args) {
          const el = document.createElement('div')
          el.innerText = `'debug' ${name} ${method} ${args.join(', ')}`
          el.className = 'px-3 py-2 bg-blue-900/50 text-blue-200 rounded border border-blue-800'
          document.getElementById('logger-output').appendChild(el)
          console.debug('LOGGER', name, method, ...args)
        }

        log(name, method, ...args) {
          const el = document.createElement('div')
          el.innerText = `'log' ${name} ${method} ${args.join(', ')}`
          el.className = 'px-3 py-2 bg-green-900/50 text-green-200 rounded border border-green-800'
          document.getElementById('logger-output').appendChild(el)
          console.log('LOGGER', name, method, ...args)
        }

        warn(name, method, ...args) {
          const el = document.createElement('div')
          el.innerText = `'warn' ${name} ${method} ${args.join(', ')}`
          el.className = 'px-3 py-2 bg-orange-900/50 text-orange-200 rounded border border-orange-800'
          document.getElementById('logger-output').appendChild(el)
          console.warn('LOGGER', name, method, ...args)
        }

        error(name, method, ...args) {
          const el = document.createElement('div')
          el.innerText = `'error' ${name} ${method} ${args.join(', ')}`
          el.className = 'px-3 py-2 bg-red-900/50 text-red-200 rounded border border-red-800'
          document.getElementById('logger-output').appendChild(el)
          console.error('LOGGER', name, method, ...args)
        }

        time(start, label) {
          const el = document.createElement('div')
          el.innerText = `'time' ${start} ${label}`
          el.className = 'px-3 py-2 bg-gray-800 text-gray-300 rounded border border-gray-700'
          document.getElementById('logger-output').appendChild(el)
          start ? console.time(label) : console.timeEnd(label)
        }

        timeLog(method, ...args) {
          const el = document.createElement('div')
          el.innerText = `'timeLog' ${method} ${args.join(', ')}`
          el.className = 'px-3 py-2 bg-gray-800 text-gray-300 rounded border border-gray-700'
          document.getElementById('logger-output').appendChild(el)
          console.timeLog(method, ...args)
        }
      }

      const x = new MyLogger()

      beacon.setLogger(x)

      // WC no matching key/topic errors override
      window.addEventListener('unhandledrejection', function (e) {
        const message = e && e.reason && typeof e.reason.message === 'string' ? e.reason.message : ''

        if (message.includes('Syncing stopped manually')) {
          e.preventDefault()
          return
        }

        x.error('Error occurred: ' + message, e.reason)
      })


      // Initialize client with selected network
      let client
      let negotiatedProtocolInterval
      const negotiatedProtocolEl = document.getElementById('negotiatedProtocol')
      let lastNegotiatedProtocol
      const rpcInput = document.getElementById('customRpcUrl')

      const protocolSelect = document.getElementById('protocolSelect')
      if (protocolSelect) {
        protocolSelect.addEventListener('change', (event) => {
          BeaconUtils.applyProtocolVersion(event.target.value)
        })
      }

      BeaconUtils.applyProtocolVersion(BeaconUtils.getStoredProtocolVersion(), { silent: true })

      // Hello World contract definition
      const HELLO_WORLD_CONTRACT = {
        code: [
          { prim: 'parameter', args: [{ prim: 'string', annots: ['%set_value'] }] },
          { prim: 'storage', args: [{ prim: 'string' }] },
          {
            prim: 'code',
            args: [
              [
                { prim: 'UNPAIR' },
                { prim: 'SWAP' },
                { prim: 'DROP' },
                { prim: 'NIL', args: [{ prim: 'operation' }] },
                { prim: 'PAIR' }
              ]
            ]
          },
          {
            prim: 'view',
            args: [
              { string: 'get_value' },
              { prim: 'unit' },
              { prim: 'string' },
              [{ prim: 'CDR' }]
            ]
          }
        ],
        storage: { string: 'Hello World' }
      }

      const updateNegotiatedProtocol = async () => {
        if (!client || !negotiatedProtocolEl) {
          return
        }

        try {
          const peers = await client.getPeers()

          if (!peers || peers.length === 0) {
            negotiatedProtocolEl.textContent = '—'
            lastNegotiatedProtocol = undefined
            return
          }

          const numericProtocols = peers
            .map((peer) => Number(peer.protocolVersion))
            .filter((version) => Number.isFinite(version) && version >= 1)

          const localPreferredRaw =
            typeof beacon.getPreferredMessageProtocolVersion === 'function'
              ? Number(beacon.getPreferredMessageProtocolVersion())
              : NaN
          const localPreferred =
            Number.isFinite(localPreferredRaw) && localPreferredRaw >= 1 ? localPreferredRaw : 2

          const negotiatedVersion = numericProtocols.length
            ? Math.min(localPreferred, ...numericProtocols)
            : 1

          const suffix = numericProtocols.length === 0 ? ' (legacy)' : ''
          negotiatedProtocolEl.textContent = `v${negotiatedVersion}${suffix}`

          if (negotiatedVersion !== lastNegotiatedProtocol) {
            lastNegotiatedProtocol = negotiatedVersion
          }
        } catch (error) {
          negotiatedProtocolEl.textContent = '—'
          lastNegotiatedProtocol = undefined
        }
      }

      const initClient = async () => {
        const selectedBlockchain = BeaconUtils.getSelectedBlockchain()
        const selectedNetwork = BeaconUtils.getSelectedNetwork()

        if (client) {
          await client.destroy()
        }

        // Determine network configuration based on blockchain
        let network
        if (selectedBlockchain === 'tezos-tezlink') {
          network = {
            type: beacon.NetworkType.MAINNET,
            name: 'Tezlink',
            rpcUrl: rpcInput.value || 'http://node.tezlink.nomadic-labs.com:30009/tezlink'
          }
        } else if (selectedNetwork === 'custom') {
          network = {
            type: beacon.NetworkType.CUSTOM,
            rpcUrl: rpcInput.value
          }
        } else {
          network = {
            type: selectedNetwork
          }
        }

        // Set block explorer based on blockchain
        let blockExplorer
        if (selectedBlockchain === 'tezos-tezlink') {
          blockExplorer = new beacon.TezlinkTzktBlockExplorer()
        }

        client = new beacon.DAppClient({
        name: 'Example DApp', // Name of the DApp,
        disclaimerText: 'This is an optional <b>disclaimer</b>.',
        appUrl: 'http://localhost:8080',
        blockExplorer: blockExplorer,
        errorMessages: {
          KT1RPW5kTX6WFxg8JK34rGEU24gqEEudyfvz: {
            NOT_OWNER: 'You are not the owner of this token.'
          }
        },
        walletConnectOptions: {
          projectId: '97f804b46f0db632c52af0556586a5f3',
          relayUrl: 'wss://relay.walletconnect.com'
        },
        matrixNodes: {
          [beacon.Regions.EUROPE_WEST]: [
            'beacon-node-1.diamond.papers.tech',
            'beacon-node-1.sky.papers.tech',
            'beacon-node-2.sky.papers.tech',
            'beacon-node-1.hope.papers.tech',
            'beacon-node-1.hope-2.papers.tech',
            'beacon-node-1.hope-3.papers.tech',
            'beacon-node-1.hope-4.papers.tech',
            'beacon-node-1.hope-5.papers.tech'
          ],
          [beacon.Regions.NORTH_AMERICA_EAST]: []
        },
        featuredWallets: ['kukai', 'metamask', 'airgap'],
        network: network,
        enableMetrics: true
        // matrixNodes: ['test.papers.tech', 'test2.papers.tech', 'matrix.papers.tech']
        // matrixNodes: ['beacon-node-0.papers.tech:8448']
        // matrixNodes: ['matrix.papers.tech']
        // matrixNodes: ['beacon.tztip.me']
        })

        // Set up event listeners for the new client
        client.subscribeToEvent('ACTIVE_ACCOUNT_SET', (account) => {
          updateActiveAccount()
          updateNegotiatedProtocol()
        })

        if (beacon?.BeaconEvent?.CHANNEL_CLOSED) {
          client.subscribeToEvent(beacon.BeaconEvent.CHANNEL_CLOSED, () => {
            updateNegotiatedProtocol()
          })
        }

        await updateNegotiatedProtocol()
        if (negotiatedProtocolInterval) {
          clearInterval(negotiatedProtocolInterval)
        }
        negotiatedProtocolInterval = setInterval(updateNegotiatedProtocol, 5000)
      }

      const generatePrefixedHexPayload = (sizeInBytes) => {
        const encoder = new TextEncoder()
        const message = 'x'.repeat(sizeInBytes)
        const bytes = encoder.encode(message)
        const hex = Array.from(bytes)
          .map((byte) => byte.toString(16).padStart(2, '0'))
          .join('')
        const lengthHex = bytes.length.toString(16).padStart(8, '0')
        return `0501${lengthHex}${hex}`
      }

      const getCurrentProtocolVersion = () => {
        if (typeof beacon.getPreferredMessageProtocolVersion === 'function') {
          return beacon.getPreferredMessageProtocolVersion()
        }
        return BeaconUtils.getStoredProtocolVersion()
      }

      const runSignPayloadPerfTest = async (sizeInKb) => {
        const resultEl = document.getElementById(`signPayloadLarge${sizeInKb}Result`)

        if (!client) {
          return
        }

        const sizeInBytes = sizeInKb * 1024
        const generationStart = performance.now()
        const payload = generatePrefixedHexPayload(sizeInBytes)
        const generationEnd = performance.now()

        const generationTime = (generationEnd - generationStart).toFixed(0)

        if (resultEl) {
          resultEl.textContent = `${sizeInKb}KB: Preparing…`
        }

        const requestStart = performance.now()

        // Track when message is actually sent via hook
        let sentTime = null
        window.__beaconPerf = {
          onBeforeSend: () => {
            sentTime = performance.now()
            const dappTime = (sentTime - requestStart).toFixed(0)
            if (resultEl) {
              resultEl.textContent = `${sizeInKb}KB: DApp ${dappTime}ms → Waiting for response…`
            }
          }
        }

        try {
          const signature = await client.requestSignPayload({ payload })
          const responseEnd = performance.now()

          const dappTime = sentTime ? (sentTime - requestStart).toFixed(0) : '—'
          const roundtripTime = (responseEnd - requestStart).toFixed(0)
          const protocol = getCurrentProtocolVersion()

          if (resultEl) {
            resultEl.textContent = `${sizeInKb}KB: DApp ${dappTime}ms → Roundtrip ${roundtripTime}ms (v${protocol})`
          }

          console.log(`[perf][dapp] ${sizeInKb}KB test: gen=${generationTime}ms, dapp=${dappTime}ms, roundtrip=${roundtripTime}ms, protocol=v${protocol}`)

          // Clean up hook
          delete window.__beaconPerf
        } catch (error) {
          const errorEnd = performance.now()
          const elapsed = (errorEnd - requestStart).toFixed(0)
          if (resultEl) {
            resultEl.textContent = `Failed after ${elapsed}ms: ${error.message ?? error}`
          }
          console.error('[perf][dapp] Sign payload request failed', error)
        }
      }

      // Fetch balance from RPC
      const fetchBalance = async (address, networkType) => {
        try {
          const rpcUrl = BeaconUtils.getRpcUrl(networkType, rpcInput.value)
          const response = await fetch(`${rpcUrl}/chains/main/blocks/head/context/contracts/${address}/balance`)
          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`)
          }
          const balanceText = await response.text()

          // Parse balance - response might be quoted string
          const balance = balanceText.replace(/"/g, '').trim()
          const balanceNum = parseInt(balance, 10)

          if (isNaN(balanceNum)) {
            return '—'
          }

          // Convert from mutez to tez
          const balanceInTez = (balanceNum / 1000000).toFixed(6)
          return `${balanceInTez} ꜩ`
        } catch (error) {
          return '—'
        }
      }

      // Update UI when account is connected
      const updateAccountUI = async (activeAccount) => {
        // Update address
        document.getElementById('activeAccount').innerText = activeAccount.address
        document.getElementById('copyAddress').classList.remove('hidden')

        // Update explorer link
        const explorerUrl = await BeaconUtils.getExplorerUrlForAddress(activeAccount.address, activeAccount.network.type, client)
        const explorerLink = document.getElementById('activeAccountExplorer')
        explorerLink.href = explorerUrl
        explorerLink.innerText = explorerUrl
        document.getElementById('activeAccountExplorerWrapper').classList.remove('hidden')

        // Update network, transport, and RPC
        document.getElementById('activeAccountNetwork').innerText = activeAccount.network.type
        document.getElementById('activeAccountTransport').innerText = activeAccount.origin.type

        const rpcUrl = BeaconUtils.getRpcUrl(activeAccount.network.type, rpcInput.value)
        document.getElementById('activeAccountRPC').innerText = rpcUrl
        document.getElementById('activeAccountRPCWrapper').classList.remove('hidden')

        // Fetch and update balance
        document.getElementById('activeAccountBalance').innerText = 'Loading...'
        const balance = await fetchBalance(activeAccount.address, activeAccount.network.type)
        document.getElementById('activeAccountBalance').innerText = balance

        startBalanceRefresh()
      }

      // Clear UI when account is disconnected
      const clearAccountUI = () => {
        stopBalanceRefresh()

        document.getElementById('activeAccount').innerText = 'Not connected'
        document.getElementById('copyAddress').classList.add('hidden')
        document.getElementById('activeAccountExplorerWrapper').classList.add('hidden')
        document.getElementById('activeAccountNetwork').innerText = ''
        document.getElementById('activeAccountTransport').innerText = ''
        document.getElementById('activeAccountBalance').innerText = '—'
        document.getElementById('activeAccountRPCWrapper').classList.add('hidden')
      }

      // Update button states based on account type
      const updateButtonStates = (activeAccount) => {
        const hasAccount = !!activeAccount
        const isSpecialAccount = activeAccount?.walletType === 'account_abstracted' ||
                                 activeAccount?.verificationType === 'proof_of_event'

        document.getElementById('disconnect').disabled = !hasAccount
        document.getElementById('requestProofOfEventChallenge').disabled = !isSpecialAccount
        document.getElementById('requestSimulatedProofOfEventChallenge').disabled = !isSpecialAccount
      }

      // Display the active account in the UI
      const updateActiveAccount = async () => {
        const activeAccount = await client.getActiveAccount()

        if (activeAccount) {
          await updateAccountUI(activeAccount)
        } else {
          clearAccountUI()
        }

        updateButtonStates(activeAccount)
      }

      // Initialize on page load
      BeaconUtils.populateNetworkSelect()
      // Restore blockchain selection
      const blockchainSelect = document.getElementById('blockchainSelect');
      if (blockchainSelect) {
        blockchainSelect.value = BeaconUtils.getSelectedBlockchain();
      }
      initClient()

      // Add network change handler
      document.getElementById('networkSelect').addEventListener('change', async (e) => {
        BeaconUtils.saveSelectedNetwork(e.target.value)
        await initClient()
        updateActiveAccount()
      })

      // Add blockchain change handler
      document.getElementById('blockchainSelect').addEventListener('change', async (e) => {
        BeaconUtils.saveSelectedBlockchain(e.target.value)
        BeaconUtils.populateNetworkSelect() // Update network options when blockchain changes
        await initClient()
        updateActiveAccount()
      })

      // Add RPC URL change handler
      rpcInput.addEventListener('input', (e) => {
        const selectedBlockchain = BeaconUtils.getSelectedBlockchain()
        if (selectedBlockchain === 'tezos-tezlink') {
          localStorage.setItem('tezlinkRpcUrl', e.target.value)
        } else {
          localStorage.setItem('tezosCustomRpcUrl', e.target.value)
        }
      })

      // Display the active account in the UI
      const updateColorMode = () => {
        client.getColorMode().then((colorMode) => {
          document.getElementById('activeColorMode').innerText = colorMode
        })
      }
      updateColorMode()

      // Balance refresh interval
      let balanceRefreshInterval = null

      const startBalanceRefresh = () => {
        // Clear any existing interval
        if (balanceRefreshInterval) {
          clearInterval(balanceRefreshInterval)
        }

        // Set up new interval to refresh balance every 5 seconds
        balanceRefreshInterval = setInterval(async () => {
          const activeAccount = await client.getActiveAccount()
          if (activeAccount) {
            const balance = await fetchBalance(activeAccount.address, activeAccount.network.type)
            document.getElementById('activeAccountBalance').innerText = balance
          }
        }, 5000)
      }

      const stopBalanceRefresh = () => {
        if (balanceRefreshInterval) {
          clearInterval(balanceRefreshInterval)
          balanceRefreshInterval = null
        }
      }

      // Initiate a delegate operation
      const delegate = () => {
        client.requestOperation({
          operationDetails: [
            {
              kind: beacon.TezosOperationType.DELEGATION,
              delegate: 'tz1MJx9vhaNRSimcuXPK2rW4fLccQnDAnVKJ'
            }
          ]
        })
      }

      // Initiate a delegate operation
      const sendToSelf = () => {
        return client.getActiveAccount().then((activeAccount) => {
          return client.requestOperation({
            operationDetails: [
              {
                kind: beacon.TezosOperationType.TRANSACTION,
                destination: activeAccount?.address ?? '',
                amount: '1'
              }
            ]
          })
        })
      }

      // send contract call
      const sendContractCall = () => {
        return client.getActiveAccount().then(async (activeAccount) => {
          const TZ_BUTTON_COLORS_CONTRACT = 'KT1GSdrLzGAorWKoe2z7qV3P5Df6Vmo7neZt'
          const tokenId = '925'

          // Setting the color of TzButton is only possible if you are currently the leader and own a color
          // So this call will likely fail
          try {
            await client.requestOperation({
              operationDetails: [
                {
                  kind: beacon.TezosOperationType.TRANSACTION,
                  amount: '0',
                  destination: TZ_BUTTON_COLORS_CONTRACT,
                  parameters: {
                    entrypoint: 'set_color',
                    value: {
                      int: tokenId
                    }
                  }
                }
              ]
            })
          } catch (error) {
            console.error('Contract call failed:', error)
          }
        })
      }

      // Initiate a permission request
      const requestPermission = (callback) => {
        client
          .requestPermissions()
          .then((permissions) => {
            if (callback) {
              callback(permissions)
            }
            updateActiveAccount()
          })
          .catch((error) => {
            console.error('Permission request failed:', error)
          })
      }

      // Initiate a permission request with sign request
      const requestPermissionAndSign = (callback) => {
        client
          .requestPermissions()
          .then(async (permissions) => {
            if (callback) {
              callback(permissions)
            }
            updateActiveAccount()

            await client.requestSignPayload({
              payload:
                '05010000004254657a6f73205369676e6564204d6573736167653a207465737455726c20323032332d30322d30385431303a33363a31382e3435345a2048656c6c6f20576f726c64'
            })
          })
          .catch((error) => {
            console.error('Permission and sign request failed:', error)
          })
      }

      // Initiate a Proof Of Event Request
      const requestProofOfEventChallenge = () => {
        client
          .requestProofOfEventChallenge({
            dAppChallengeId: 'my-id',
            payload: JSON.stringify({ timestamp: Date.now() })
          })
          .catch((error) => {
            console.error('Proof Of Event Challenge failed:', error)
          })
      }

      // disconnect
      const disconnect = () => {
        client
          .disconnect()
          .then(() => {
            updateActiveAccount()
            updateNegotiatedProtocol()
          })
          .catch((err) => console.error('Disconnect failed:', err.message))
      }

      const requestSimulatedProofOfEventChallenge = () => {
        client
          .requestSimulatedProofOfEventChallenge({
            payload: JSON.stringify({ timestamp: Date.now() })
          })
          .catch((error) => {
            console.error('Simulated Proof Of Event Challenge failed:', error)
          })
      }

      // Add event listener for copy address button
      document.getElementById('copyAddress').addEventListener('click', () => {
        const address = document.getElementById('activeAccount').innerText
        navigator.clipboard.writeText(address).then(() => {
          const btn = document.getElementById('copyAddress')
          const originalHTML = btn.innerHTML
          btn.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" /></svg>'
          btn.title = 'Copied!'
          setTimeout(() => {
            btn.innerHTML = originalHTML
            btn.title = 'Copy address'
          }, 2000)
        }).catch(err => {
          console.error('Failed to copy:', err)
        })
      })


      // Add event listener to the button
      document.getElementById('requestPermission').addEventListener('click', () => {
        requestPermission()
      })

      // Add event listener to the button
      document.getElementById('requestPermissionAndSign').addEventListener('click', () => {
        requestPermissionAndSign()
      })

      // Add event listener to the button
      document.getElementById('disconnect').addEventListener('click', () => {
        disconnect()
      })

      // Add event listener to the button
      document.getElementById('requestProofOfEventChallenge').addEventListener('click', () => {
        requestProofOfEventChallenge()
      })

      // Add event listener to the button
      document
        .getElementById('requestSimulatedProofOfEventChallenge')
        .addEventListener('click', () => {
          requestSimulatedProofOfEventChallenge()
        })

      // Add event listener to the button
      document.getElementById('reset').addEventListener('click', () => {
        if (document.getElementById('reset').attributes.getNamedItem('disabled') === 'true') {
          return
        }
        document.getElementById('reset').innerText = 'Cleaning up and refreshing...'
        document.getElementById('reset').setAttribute('disabled', 'true')

        client.destroy().then(() => {
          window.location.reload()
        })
      })

      // Add event listener to the button
      document.getElementById('signPayloadRaw').addEventListener('click', async () => {
        await client.requestSignPayload({
          payload:
            '05010000004254657a6f73205369676e6564204d6573736167653a207465737455726c20323032332d30322d30385431303a33363a31382e3435345a2048656c6c6f20576f726c64'
        })
      })

      // Add event listener to the button
      document.getElementById('encryptPayload').addEventListener('click', async () => {
        const encryptionResponse = await client.requestEncryptPayload({
          encryptionType: beacon.EncryptionType.ASYMMETRIC,
          encryptionCryptoOperation: beacon.EncryptionOperation.ENCRYPT,
          payload: 'my-secret-string'
        })

        await new Promise((resolve) => setTimeout(resolve, 2000))

        await client.requestEncryptPayload({
          encryptionType: beacon.EncryptionType.ASYMMETRIC,
          encryptionCryptoOperation: beacon.EncryptionOperation.DECRYPT,
          payload: encryptionResponse.payload
        })
      })

      // Add event listener to the button
      document.getElementById('signPayloadOperation').addEventListener('click', async () => {
        await client.requestSignPayload({
          signingType: beacon.SigningType.OPERATION,
          payload: '03test'
        })
      })

      // Add event listener to the button
      document.getElementById('signPayloadMicheline').addEventListener('click', async () => {
        await client.requestSignPayload({
          signingType: beacon.SigningType.MICHELINE,
          payload:
            '05010000004254657a6f73205369676e6564204d6573736167653a206d79646170702e636f6d20323032312d30312d31345431353a31363a30345a2048656c6c6f20776f726c6421'
        })
      })

      document.getElementById('signPayloadLarge50').addEventListener('click', () => {
        runSignPayloadPerfTest(50)
      })

      document.getElementById('signPayloadLarge100').addEventListener('click', () => {
        runSignPayloadPerfTest(100)
      })

      document.getElementById('signPayloadLarge20').addEventListener('click', () => {
        runSignPayloadPerfTest(20)
      })

      document.getElementById('signPayloadLarge30').addEventListener('click', () => {
        runSignPayloadPerfTest(30)
      })

      // Add event listener to the button
      document.getElementById('clearActiveAccount').addEventListener('click', () => {
        client.setActiveAccount().then(() => {
          updateActiveAccount()
        })
      })

      // Add event listener to the button
      document.getElementById('getExtensions').addEventListener('click', () => {
        beacon.availableTransports.availableExtensions.then((extensions) => {
          alert(
            `There are ${extensions.length} extensions installed.`
          )
        })
      })

      // Add event listener to the button
      document.getElementById('getAccounts').addEventListener('click', () => {
        client.getAccounts().then((accounts) => {
          alert(`There are ${accounts.length} accounts stored.`)
        })
      })

      // Add event listener to the button
      document.getElementById('switchAccount').addEventListener('click', () => {
        client.getAccounts().then((accounts) => {
          client.getActiveAccount().then((activeAccount) => {
            if (!activeAccount) {
              if (accounts.length === 0) {
                return alert('No account to switch to')
              }

              return client.setActiveAccount(accounts[0]).then(() => {
                updateActiveAccount()
              })
            }
            const filtered = accounts.filter(
              (acc) => acc.accountIdentifier !== activeAccount.accountIdentifier
            )
            if (filtered.length === 0) {
              return alert('No account to switch to')
            }

            client.setActiveAccount(filtered[0]).then(() => {
              updateActiveAccount()
            })
          })
        })
      })

      // Add event listener to the button
      document.getElementById('removePeer').addEventListener('click', () => {
        client.getPeers().then((peers) => {
          if (peers.length > 0) {
            client.removePeer(peers[0], true).then(() => {
              updateActiveAccount()
            })
          }
        })
      })

      document.getElementById('externalInit').addEventListener('click', () => {
        client.init().then(() => {
          client.requestPermissions().then((permissions) => {
            if (callback) {
              callback(permissions)
            }
            updateActiveAccount()
          })
        })
      })



      // Add event listener to the button
      document.getElementById('showPrepareAndHide').addEventListener('click', () => {
        client.showPrepare()
        setTimeout(() => {
          client.hideUI()
        }, 2000)
      })

      // Add event listener to the button
      document.getElementById('color-mode-light').addEventListener('click', () => {
        client.setColorMode('light')
        updateColorMode()
      })

      // Add event listener to the button
      document.getElementById('color-mode-dark').addEventListener('click', () => {
        client.setColorMode('dark')
        updateColorMode()
      })

      // Add event listener to the button
      document.getElementById('deserializeData').addEventListener('click', () => {
        const value = document.getElementById('beacon-textbox').value
        new beacon.Serializer()
          .deserialize(value)
          .catch(console.error)
      })

      // Add event listener to the button
      document.getElementById('serializeData').addEventListener('click', () => {
        const value = document.getElementById('beacon-textbox-serialize').value
        const parsed = JSON.parse(value)
        new beacon.Serializer().serialize(parsed).catch(console.error)
      })

      // Add event listener to the button
      document.getElementById('sendNotification').addEventListener('click', () => {
        client.sendNotification('Beacon Test', 'Message', '', 'xtz')
      })

      // Add event listener to the button
      document.getElementById('dumpState').addEventListener('click', async () => {
        const extraInfo = {
          'Selected Blockchain': BeaconUtils.getSelectedBlockchain(),
          'Selected Network': BeaconUtils.getSelectedNetwork(),
          'Custom RPC URL': document.getElementById('customRpcUrl').value || 'Not set',
          'Protocol Version': getCurrentProtocolVersion(),
          'Negotiated Protocol': document.getElementById('negotiatedProtocol').textContent
        }

        await BeaconUtils.dumpState('DApp', client, extraInfo)
      })

      // Send Tezos Function
      const sendTezosTransaction = async () => {
        try {
          const recipient = document.getElementById('sendRecipientAddress').value.trim()
          const amount = document.getElementById('sendAmount').value.trim()

          if (!recipient || !amount || parseFloat(amount) <= 0) {
            return
          }

          // Convert tez to mutez (1 tez = 1,000,000 mutez)
          const amountInMutez = Math.floor(parseFloat(amount) * 1000000).toString()

          await client.requestOperation({
            operationDetails: [
              {
                kind: beacon.TezosOperationType.TRANSACTION,
                destination: recipient,
                amount: amountInMutez
              }
            ]
          })

          // Clear inputs after successful send
          document.getElementById('sendRecipientAddress').value = ''
          document.getElementById('sendAmount').value = ''
        } catch (error) {
          console.error('Error sending transaction:', error)
        }
      }

      // Contract Deployment Functions
      const CONTRACT_ADDRESS_KEY = 'beacon-example-contract-address'
      const CONTRACT_OWNER_KEY = 'beacon-example-contract-owner'

      const getStoredContractAddress = () => localStorage.getItem(CONTRACT_ADDRESS_KEY)
      const getStoredContractOwner = () => localStorage.getItem(CONTRACT_OWNER_KEY)

      // Handle post-deployment contract address discovery
      const handleContractDeployment = async (transactionHash, ownerAddress) => {
        try {
          const network = (await client.getActiveAccount()).network.type
          const rpcUrl = BeaconUtils.getRpcUrl(network, rpcInput.value)

          const contractAddress = await BeaconUtils.findOriginatedContract(transactionHash, rpcUrl, 20)

          if (contractAddress) {
            localStorage.setItem(CONTRACT_ADDRESS_KEY, contractAddress)
            localStorage.setItem(CONTRACT_OWNER_KEY, ownerAddress)
            updateContractUI()
          } else {
            console.error('Could not find contract address in recent blocks')
            alert('Contract deployment completed, but could not find the contract address. Please set it manually.')
          }
        } catch (error) {
          console.error('Error finding contract address:', error)
          alert('Error finding contract address. Please set it manually.')
        }
      }

      const updateContractUI = async () => {
        const contractAddress = getStoredContractAddress()
        const hasContract = !!contractAddress

        if (hasContract) {
          document.getElementById('contractAddress').innerText = contractAddress
          document.getElementById('contractAddressWrapper').classList.remove('hidden')
          document.getElementById('deployContract').innerText = 'Redeploy Contract'
          document.getElementById('deployContract').disabled = false
          document.getElementById('setContractValue').disabled = false
          document.getElementById('getContractValue').disabled = false
          document.getElementById('clearContract').disabled = false

          // Update explorer link
          const activeAccount = await client.getActiveAccount()
          if (activeAccount) {
            const explorerUrl = await BeaconUtils.getExplorerUrlForAddress(contractAddress, activeAccount.network.type, client)
            const explorerLink = document.getElementById('contractExplorer')
            explorerLink.href = explorerUrl
            explorerLink.innerText = explorerUrl
          }
        } else {
          document.getElementById('contractAddressWrapper').classList.add('hidden')
          document.getElementById('deployContract').innerText = 'Deploy Hello World Contract'
          document.getElementById('deployContract').disabled = false
          document.getElementById('setContractValue').disabled = true
          document.getElementById('getContractValue').disabled = true
          document.getElementById('clearContract').disabled = true
          document.getElementById('contractCurrentValue').innerText = 'No value loaded'
        }
      }

      const deployContract = async () => {
        try {
          const activeAccount = await client.getActiveAccount()
          if (!activeAccount) {
            alert('Please connect your wallet first')
            return
          }

          const result = await client.requestOperation({
            operationDetails: [
              {
                kind: beacon.TezosOperationType.ORIGINATION,
                balance: '0',
                script: HELLO_WORLD_CONTRACT
              }
            ]
          })

          if (result.transactionHash) {
            // Wait for the operation to be included in a block, then search via RPC
            setTimeout(() => handleContractDeployment(result.transactionHash, activeAccount.address), 5000)
          }
        } catch (error) {
          console.error('Error deploying contract:', error)
          alert(`Error deploying contract: ${error.message}`)
        }
      }

      const setContractValue = async () => {
        try {
          const contractAddress = getStoredContractAddress()
          const newValue = document.getElementById('contractValueInput').value

          if (!newValue) {
            return
          }

          await client.requestOperation({
            operationDetails: [
              {
                kind: beacon.TezosOperationType.TRANSACTION,
                destination: contractAddress,
                amount: '0',
                parameters: {
                  entrypoint: 'set_value',
                  value: { string: newValue }
                }
              }
            ]
          })

          document.getElementById('contractValueInput').value = ''
        } catch (error) {
          console.error('Error setting contract value:', error)
        }
      }

      const getContractValue = async () => {
        try {
          const contractAddress = getStoredContractAddress()
          const activeAccount = await client.getActiveAccount()
          const network = activeAccount.network.type
          const rpcUrl = BeaconUtils.getRpcUrl(network, rpcInput.value)

          const response = await fetch(`${rpcUrl}/chains/main/blocks/head/context/contracts/${contractAddress}`)
          const contractData = await response.json()
          const storage = contractData.script?.storage || contractData.storage

          const value = storage.string || storage
          document.getElementById('contractCurrentValue').innerText = value
          document.getElementById('contractCurrentValue').classList.remove('text-gray-400')
          document.getElementById('contractCurrentValue').classList.add('text-white')
        } catch (error) {
          console.error('Error getting contract value:', error)
        }
      }

      const clearContract = () => {
        if (confirm('Are you sure you want to clear the stored contract address?')) {
          localStorage.removeItem(CONTRACT_ADDRESS_KEY)
          localStorage.removeItem(CONTRACT_OWNER_KEY)
          updateContractUI()
        }
      }

      // Fill own address button event listener
      document.getElementById('fillOwnAddress').addEventListener('click', async () => {
        const activeAccount = await client.getActiveAccount()
        if (activeAccount) {
          document.getElementById('sendRecipientAddress').value = activeAccount.address
          document.getElementById('sendAmount').value = '0.1'
        }
      })

      // Send Tezos event listener
      document.getElementById('sendTezos').addEventListener('click', sendTezosTransaction)

      // Contract event listeners
      document.getElementById('deployContract').addEventListener('click', deployContract)
      document.getElementById('setContractValue').addEventListener('click', setContractValue)
      document.getElementById('getContractValue').addEventListener('click', getContractValue)
      document.getElementById('clearContract').addEventListener('click', clearContract)

      document.getElementById('copyContractAddress').addEventListener('click', () => {
        const address = document.getElementById('contractAddress').innerText
        navigator.clipboard.writeText(address).then(() => {
          const btn = document.getElementById('copyContractAddress')
          const originalHTML = btn.innerHTML
          btn.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" /></svg>'
          btn.title = 'Copied!'
          setTimeout(() => {
            btn.innerHTML = originalHTML
            btn.title = 'Copy address'
          }, 2000)
        }).catch(err => {
          console.error('Failed to copy:', err)
        })
      })

      // Set manual contract address
      document.getElementById('setManualContract').addEventListener('click', async () => {
        const address = document.getElementById('manualContractAddress').value.trim()

        if (!address) {
          alert('Please enter a contract address')
          return
        }

        if (!address.startsWith('KT1')) {
          alert('Invalid contract address. Must start with KT1')
          return
        }

        const activeAccount = await client.getActiveAccount()
        if (activeAccount) {
          localStorage.setItem(CONTRACT_ADDRESS_KEY, address)
          localStorage.setItem(CONTRACT_OWNER_KEY, activeAccount.address)
          document.getElementById('manualContractAddress').value = ''
          await updateContractUI()
        } else {
          alert('Please connect your wallet first')
        }
      })

      // Initialize contract UI on page load
      updateContractUI()
    </script>
  </body>
</html>
