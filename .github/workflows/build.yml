name: Build, Test and Analyze

on: push

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v2
        with:
          fetch-depth: 0 # Shallow clones should be disabled for a better relevancy of analysis

      - name: Cache node modules
        uses: actions/cache@v4
        with:
          path: ~/.npm
          key: ${{ runner.os }}-node-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-node-

      - name: Node 18
        uses: actions/setup-node@v1
        with:
          node-version: 18.x

      - name: Prepare
        run: npm ci

      - name: Build
        run: npm run build

      - name: Test (unit + integration)
        run: npm run test

      - name: Setup FFMPEG
        uses: FedericoCarboni/setup-ffmpeg@v1
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
        id: setup-ffmpeg

      # ───────────────────────────────────────────────────────────────────────────────
      # ▼ E2E STEPS ▼
      # ───────────────────────────────────────────────────────────────────────────────

      # 1. Install Playwright’s browsers & required Linux dependencies
      #    (this is equivalent to running `npx playwright install --with-deps`)
      - name: Install Playwright browsers & system dependencies
        run: npx playwright install --with-deps

      # 2. Run all E2E specs in “e2e/” with a single worker (no parallelism),
      #    wrapped in xvfb‐run so that any “headed” browsers can still launch.
      #
      #    We add “--workers=1” here so that only one spec file in “e2e/” runs at a time.
      #    That way, each file’s `spawn('npx', ['http-server', 'examples', '-p', 1234], …)`
      #    happens in isolation, and there’s never a second attempt to bind to 1234 or 4321
      #    while another server is still running from a previous spec.
      #
      #    If you have other flags (e.g. custom timeouts), append them as needed.
      - name: Run E2E tests
        run: |
          xvfb-run --auto-servernum --server-args="-screen 0 1280x720x24" \
            npx playwright test e2e --workers=1

      # ───────────────────────────────────────────────────────────────────────────────

      # - name: Upload
      #   uses: actions/upload-artifact@v1
      #   with:
      #     name: video
      #     path: e2e/output/combined.webm

      # - name: Analyze with SonarCloud
      #   uses: sonarsource/sonarcloud-github-action@master
      #   env:
      #     GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      #     SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
